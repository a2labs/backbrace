/*
  backbrace
  Â© 2012 - Copyright appendTo, LLC
  Author(s): Jim Cowart, Doug Neiner
  License: Dual licensed MIT (http://opensource.org/licenses/MIT) & GPL (http://opensource.org/licenses/GPL-2.0)
  Version 0.0.1
 */
(function(e,t){typeof module=="object"&&module.exports?module.exports=function(e,n,r,i){return t(e,n,r,i)}:typeof define=="function"&&define.amd?define(["underscore","backbone","riveter","postal"],function(n,r,i,s){return t(n,r,i,s,e)}):e.backbrace=t(e._,e.Backbone,e.riveter,e.postal,e)})(this,function(e,t,n,r,i,s){var o=i.backbrace||{},u=/^<([a-z][a-z0-9]*)[^>]*>(.*?)<\/\1>$/i;o.View=t.View.extend({$:function(t){return e.isObject(t)||u.test(t)?$(t):this.$el.find(t)},dataToJSON:function(){var t={};return this.model&&(t=this.model.toJSON()),this.collection&&e.extend(t,{items:this.collection.toJSON()}),t}});var a={_preInit:function(n,r){r=(this instanceof t.View?n:r)||{},this.subscriptions=e.extend({},this.subscriptions,r.subscriptions),this.publications=e.extend({},this.publications,r.publications),this.messaging=this.messaging||{},this.configureMessaging()},mixin:{configureMessaging:function(){this.setupSubscriptions(),this.bridgeEvents()},bridgeEvents:function(){this.unbridgeEvents(),e.isEmpty(this.publications)||e.each(this.publications,function(t,n){var i=t;this.messaging.publications[n]||(this.messaging.publications[n]={}),e.isObject(t)||(i={},i[t]=e.identity),e.each(i,function(t,i){var s=i.split(" "),o=s[0],u=s[1],a=function(){var e=Array.prototype.slice.call(arguments,0),n=t.apply(this,e);r.publish({channel:o,topic:u,data:n||{}})};this.on(n,a,this),this.messaging.publications[n][i]=e.bind(function(){this.off(n,a)},this)},this)},this)},unbridgeEvents:function(){this.messaging.publications&&e.each(this.messaging.publications,function(t){e.each(t,function(e){while(e.length)e.pop()()})}),this.messaging.publications={}},setupSubscriptions:function(){this.unwindSubscriptions(),e.isEmpty(this.subscriptions)||e.each(this.subscriptions,function(t,n){t=e.isArray(t)?t:[t],e.each(t,function(e){var t=e.split(" "),i=t[0],s=t[1];this[n]&&(this.messaging.subscriptions[e]=r.subscribe({channel:i,topic:s,callback:this[n]}).withContext(this))},this)},this)},unwindSubscriptions:function(){this.messaging.subscriptions&&e.each(this.messaging.subscriptions,function(e){e.unsubscribe()}),this.messaging.subscriptions={}}}};return n(o.View),o.View=o.View.compose(a),o})