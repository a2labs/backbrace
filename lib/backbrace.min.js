/*
  backbrace
  Â© 2012 - Copyright appendTo, LLC
  Author(s): Jim Cowart, Doug Neiner
  License: Dual licensed MIT (http://opensource.org/licenses/MIT) & GPL (http://opensource.org/licenses/GPL-2.0)
  Version 0.0.1
 */
(function(e,t){typeof module=="object"&&module.exports?module.exports=function(e,n,r,i){return t(e,n,r,i)}:typeof define=="function"&&define.amd?define(["underscore","backbone","riveter","postal"],function(n,r,i,s){return t(n,r,i,s,e)}):e.backbrace=t(e._,e.Backbone,e.riveter,e.postal,e)})(window||this,function(e,t,n,r,i,s){var o=i.backbrace||{},u=/^<([a-z][a-z0-9]*)[^>]*>(.*?)<\/\1>$/i;o.View=t.View.extend({$:function(t){return e.isObject(t)||u.test(t)?$(t):this.$el.find(t)},dataToJSON:function(){var t={};return this.model&&(t=this.model.toJSON()),this.collection&&e.extend(t,{items:this.collection.toJSON()}),t}}),o.Model=t.Model;var a=o.messagingMixin={_preInit:function(n,r){r=(this instanceof t.View?n:r)||{},this.subscriptions=e.extend({},this.subscriptions,r.subscriptions),this.publications=e.extend({},this.publications,r.publications),this.messaging=this.messaging||{},this.configureMessaging()},mixin:{configureMessaging:function(){this.setupSubscriptions(),this.bridgeEvents()},bridgeEvents:function(){this.unbridgeEvents(),e.isEmpty(this.publications)||e.each(this.publications,function(t,n){var i=t;this.messaging.publications[n]||(this.messaging.publications[n]={}),e.isObject(t)||(i={},i[t]=e.identity),e.each(i,function(t,i){var s=i.split(" "),o=s[0],u=s[1],a=function(){var e=Array.prototype.slice.call(arguments,0),n=t.apply(this,e);r.publish({channel:o,topic:u,data:n||{}})};this.on(n,a,this),this.messaging.publications[n][i]=e.bind(function(){this.off(n,a)},this)},this)},this)},unbridgeEvents:function(){this.messaging.publications&&e.each(this.messaging.publications,function(t){e.each(t,function(e){while(e.length)e.pop()()})}),this.messaging.publications={}},setupSubscriptions:function(){this.unwindSubscriptions(),e.isEmpty(this.subscriptions)||e.each(this.subscriptions,function(t,n){t=e.isArray(t)?t:[t],e.each(t,function(e){var t=e.split(" "),i=t[0],s=t[1];this[n]&&(this.messaging.subscriptions[e]=r.subscribe({channel:i,topic:s,callback:this[n]}).withContext(this))},this)},this)},unwindSubscriptions:function(){this.messaging.subscriptions&&e.each(this.messaging.subscriptions,function(e){e.unsubscribe()}),this.messaging.subscriptions={}}}},f=o.modelValidationMixin={validate:function(t){if(this.rules){var n=e.extend(this.toJSON(),t);this.set("_errors",{},{silent:!0});var r={};e.each(t,function(e,t){if(this.rules[t]){var i=$.trim(e),s=0,o;for(;s<this.rules[t].length;s++){(function(e){e=e.predicate?e:{predicate:e,errorMsg:"The 'key' has validation errors."},o=e.predicate.call(this,i,n);var s=e.errorMsg;Object.prototype.toString.call(o)==="[object String]"&&(s=o||e.errorMsg,o=!o),o||(r[t]||(r[t]=[]),r[t].push(s))})(this.rules[t][s]);if(!o&&this.rules[t][s].stopIfBroken)break}}},this),this.set("_errors",r,{silent:!0});if(!e.isEmpty(r))return r}},hasErrors:function(){return!e.isEmpty(this.get("_errors"))}},l=o.viewValidation={getValidationTarget:function(){return".validation"},showValidation:function(t,n){var r;(r=this.getValidationTarget())&&e.each(n,function(e,t){this.$("[name='"+t+"']").closest(r).addClass("error")},this)},useValidatedModel:function(e){this.model&&this.model!==e&&this.model.off("error",this.showValidation,this),this.model=e,this.model.on("error",this.showValidation,this)}},c=o.collectionViewMixin=collectionView={_postInit:function(){this.childViews={},this.collection&&(this.collection.on("reset",this.render,this),this.collection.on("add",this.addChild,this),this.collection.on("remove",this.removeChild,this))},mixin:{getViewConstructor:function(e){var t=this.options.viewType||this.viewType;if(!t)throw new Error("A `viewType` must be specified");return t},addChild:function(e){var t=this.collection.indexOf(e),n=this.getViewConstructor(e),r=new n({model:e});this.childViews[e.cid]=r,this.renderChild(r,t)},renderChild:function(e,t){e.render(),this.$el.append(e.$el)},removeChild:function(e){this.childViews[e.cid]&&(this.childViews[e.cid].remove(),delete this.childViews[e.cid])},removeChildView:function(e){this.removeChild(e.model)},removeAllChildren:function(){e.each(this.childViews,this.removeChildView,this)},remove:function(){return this.removeAllChildren(),this.undelegateEvents(),this.$el.remove(),this},render:function(e){this.trigger("preRender",e),this.removeAllChildren(),this.collection.forEach(function(e){this.addChild(e)},this),this.trigger("rendered",e)}}};return n(o.View),n(o.Model),o.View=o.View.compose(a,l),o.CollectionView=o.View.compose(c),o.Model=o.Model.compose(a,f),o})